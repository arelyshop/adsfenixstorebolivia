<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKT Fenix Store - Visualizador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
        }

        .ad-card { 
            aspect-ratio: 2/3; 
            transition: transform 0.2s ease-in-out; 
        }
        
        .ad-card:hover { 
            transform: translateY(-4px); 
        }

        /* Animación para el estado Activo */
        @keyframes pulse-live {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* Animación para la tuerca en proceso */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-spin-slow {
            animation: spin-slow 4s linear infinite;
        }

        .status-badge-activo { 
            background-color: #22c55e; 
            color: white; 
            animation: pulse-live 2s infinite;
        }

        .status-badge-programado { 
            background-color: #eab308; 
            color: white; 
        }

        /* Estilo base para etiquetas de tipo */
        .tipo-tag-default { 
            background-color: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(4px); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            color: white; 
        }

        /* Estilo resaltado para Combos/Tricombos */
        .tipo-tag-resaltado {
            background-color: #dc2626; /* Rojo intenso */
            border: 1px solid #ef4444;
            color: white;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
        }

        .filter-active { 
            border-color: #3b82f6 !important; 
            background-color: #eff6ff !important; 
            color: #1d4ed8 !important;
        }

        .copy-feedback { 
            animation: fadeInOut 1.5s ease-in-out forwards; 
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(5px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-5px); }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-[1600px] mx-auto">
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tighter uppercase">MKT FENIX STORE</h1>
                <p class="text-slate-500 text-sm font-medium">Anuncios activos y próximas publicaciones</p>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <button onclick="setFilter('all')" id="btn-all" class="filter-btn bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-200 flex items-center gap-2 hover:bg-slate-50 transition-all filter-active">
                    <span class="text-xs font-bold uppercase tracking-wider">TODOS</span>
                </button>
                <button onclick="setFilter('Activo')" id="btn-activo" class="filter-btn bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-200 flex items-center gap-2 hover:bg-slate-50 transition-all">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-xs font-bold uppercase tracking-wider"><span id="active-count">0</span> ACTIVOS</span>
                </button>
                <button onclick="setFilter('Programado')" id="btn-programado" class="filter-btn bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-200 flex items-center gap-2 hover:bg-slate-50 transition-all">
                    <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                    <span class="text-xs font-bold uppercase tracking-wider"><span id="scheduled-count">0</span> PROGRAMADOS</span>
                </button>
            </div>
        </header>

        <div class="mb-8">
            <div class="relative max-w-md">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                </span>
                <input type="text" id="searchInput" placeholder="Buscar anuncios, asesoras o ciudades..." class="w-full pl-12 pr-4 py-3 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm text-sm focus:outline-none transition-all">
            </div>
        </div>

        <div id="adsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-6">
            <div class="col-span-full py-20 text-center text-slate-400 italic font-medium">Cargando anuncios...</div>
        </div>
    </div>

    <!-- Modal de Información Completa -->
    <div id="videoModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4">
        <button onclick="closeModal()" class="absolute top-6 right-6 text-white hover:scale-110 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
        <div class="max-w-[420px] w-full bg-white rounded-[2.5rem] overflow-hidden shadow-2xl fade-in">
            <div class="p-8">
                <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                </div>
                
                <h2 id="modalTitle" class="font-black text-2xl text-slate-800 leading-tight mb-2 tracking-tighter"></h2>
                <div id="modalTypeBadge" class="inline-block px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest mb-6"></div>
                
                <div class="space-y-4">
                    <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-2xl">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs">A</div>
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Asesora Responsable</p>
                            <p id="modalAsesora" class="text-slate-800 font-black"></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Ciudad</p>
                            <p id="modalCiudad" class="text-slate-800 font-black"></p>
                        </div>
                        <!-- Contenedor de Video REEL con colores dinámicos -->
                        <div id="modalVideoStatusContainer" class="p-4 rounded-2xl transition-colors duration-300">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Video REEL</p>
                            <p id="modalVideoStatus" class="font-black"></p>
                        </div>
                    </div>

                    <div class="p-4 bg-blue-600 rounded-2xl text-white shadow-lg shadow-blue-200">
                        <p id="modalDateLabel" class="text-[10px] text-blue-100 font-bold uppercase tracking-widest"></p>
                        <p id="modalFecha" class="text-xl font-black italic"></p>
                    </div>
                </div>

                <button onclick="closeModal()" class="w-full mt-8 bg-slate-900 text-white font-black py-4 rounded-2xl uppercase tracking-widest text-xs hover:bg-slate-800 transition-all">Cerrar Información</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/.netlify/functions/api';
        let allAds = [];
        let currentFilter = 'all';

        async function fetchData() {
            try {
                const response = await fetch(`${API_URL}/anuncios`);
                const data = await response.json();
                
                // Filtrar solo anuncios Activos y Programados
                allAds = data.filter(ad => ad.estado === 'Activo' || ad.estado === 'Programado');
                
                renderPublicView();
            } catch (e) {
                console.error("Error al cargar datos");
                renderPublicView();
            }
        }

        function renderPublicView() {
            const grid = document.getElementById('adsGrid');
            grid.innerHTML = '';
            
            const filtered = allAds.filter(ad => {
                const matchesStatus = currentFilter === 'all' || ad.estado === currentFilter;
                const search = document.getElementById('searchInput').value.toLowerCase();
                const matchesSearch = 
                    ad.nombre.toLowerCase().includes(search) || 
                    ad.asesora_nombre.toLowerCase().includes(search) ||
                    ad.ciudad.toLowerCase().includes(search);
                return matchesStatus && matchesSearch;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full py-20 text-center text-slate-400 italic font-medium">No se encontraron anuncios vigentes.</div>';
                updateHeaderCounts();
                return;
            }

            filtered.forEach(ad => {
                const isActivo = ad.estado === 'Activo';
                const badgeClass = isActivo ? 'status-badge-activo' : 'status-badge-programado';
                const datePrefix = isActivo ? 'Activo desde:' : 'Inicio:';
                
                // Lógica de color para tipo de anuncio
                const esPromo = ad.tipo === 'COMBO' || ad.tipo === 'TRICOMBO';
                const tipoClass = esPromo ? 'tipo-tag-resaltado' : 'tipo-tag-default';

                // ¿Está el video en proceso?
                const enProceso = ad.video_reel.toLowerCase() === 'en proceso';

                grid.innerHTML += `
                    <div class="ad-card relative group rounded-[2rem] overflow-hidden shadow-md bg-white">
                        <img src="${ad.foto_url}" class="absolute inset-0 w-full h-full object-cover transition-transform group-hover:scale-110" onerror="this.src='https://via.placeholder.com/400x600?text=Fenix+Store'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                        
                        <!-- Overlay de Tuerca Girando si está EN PROCESO -->
                        ${enProceso ? `
                            <div class="absolute inset-0 flex flex-col items-center justify-center z-10 pointer-events-none bg-black/30 backdrop-blur-[2px]">
                                <div class="bg-white/20 p-4 rounded-full border border-white/30 shadow-2xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin-slow">
                                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </div>
                                <span class="text-white text-[10px] font-black uppercase tracking-[0.2em] mt-3 drop-shadow-md">Video en Edición</span>
                            </div>
                        ` : ''}

                        <div class="absolute top-4 left-4 flex flex-col gap-2">
                            <div class="${badgeClass} px-3 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest flex items-center gap-1.5 w-fit shadow-lg">
                                ${isActivo ? '<span class="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>' : ''}
                                ${ad.estado}
                            </div>
                            <div class="bg-black/40 backdrop-blur-md px-2.5 py-1 rounded-xl w-fit">
                                <p class="text-[8px] text-white/90 font-bold uppercase tracking-tighter">${datePrefix} ${ad.fecha_inicio}</p>
                            </div>
                        </div>

                        <!-- Botón con Icono de Ojo -->
                        <button onclick='openModal(${JSON.stringify(ad)})' class="absolute top-4 right-4 bg-white/10 backdrop-blur-md p-2 rounded-full text-white hover:bg-white/30 transition-all z-20">
                            <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px" fill="currentColor"><path d="M607.5-372.5Q660-425 660-500t-52.5-127.5Q555-680 480-680t-127.5 52.5Q300-575 300-500t52.5 127.5Q405-320 480-320t127.5-52.5Zm-204-51Q372-455 372-500t31.5-76.5Q435-608 480-608t76.5 31.5Q588-545 588-500t-31.5 76.5Q525-392 480-392t-76.5-31.5ZM214-281.5Q94-363 40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200q-146 0-266-81.5ZM480-500Zm207.5 160.5Q782-399 832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280q113 0 207.5-59.5Z"/></svg>
                        </button>

                        <div class="absolute bottom-0 left-0 right-0 p-5">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] text-white/70 uppercase tracking-widest font-black">${ad.ciudad}</span>
                                <span class="px-2 py-0.5 rounded text-[7px] font-black uppercase ${tipoClass}">${ad.tipo}</span>
                            </div>
                            <h3 class="text-white font-bold text-sm md:text-lg mb-3 leading-tight truncate">${ad.nombre}</h3>
                            
                            <div class="flex items-center justify-between gap-2 pt-4 border-t border-white/10">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-[10px] font-black text-white uppercase flex-shrink-0 shadow-inner">${ad.asesora_nombre.charAt(0)}</div>
                                    <div class="flex flex-col truncate">
                                        <p class="text-[10px] text-white font-black truncate">${ad.asesora_nombre}</p>
                                        <button onclick="copyToClipboard('${ad.whatsapp}', this)" class="text-left text-[9px] text-white/60 hover:text-white flex items-center gap-1 transition-colors">
                                            <span class="font-bold font-mono">${ad.whatsapp}</span>
                                        </button>
                                    </div>
                                </div>
                                <a href="https://wa.me/${ad.whatsapp.replace(/\D/g, '')}" target="_blank" class="bg-green-500 p-2.5 rounded-2xl text-white shadow-lg hover:bg-green-400 hover:scale-110 transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 510 512.459" fill="white">
                                        <path d="M435.689 74.468C387.754 26.471 324 .025 256.071 0 116.098 0 2.18 113.906 2.131 253.916c-.024 44.758 11.677 88.445 33.898 126.946L0 512.459l134.617-35.311c37.087 20.238 78.85 30.891 121.345 30.903h.109c139.949 0 253.88-113.917 253.928-253.928.024-67.855-26.361-131.645-74.31-179.643v-.012zm-179.618 390.7h-.085c-37.868-.011-75.016-10.192-107.428-29.417l-7.707-4.577-79.886 20.953 21.32-77.889-5.017-7.987c-21.125-33.605-32.29-72.447-32.266-112.322.049-116.366 94.729-211.046 211.155-211.046 56.373.025 109.364 22.003 149.214 61.903 39.853 39.888 61.781 92.927 61.757 149.313-.05 116.377-94.728 211.058-211.057 211.058v.011zm115.768-158.067c-6.344-3.178-37.537-18.52-43.358-20.639-5.82-2.119-10.044-3.177-14.27 3.178-4.225 6.357-16.388 20.651-20.09 24.875-3.702 4.238-7.403 4.762-13.747 1.583-6.343-3.178-26.787-9.874-51.029-31.487-18.86-16.827-31.597-37.598-35.297-43.955-3.702-6.355-.39-9.789 2.775-12.943 2.849-2.848 6.344-7.414 9.522-11.116s4.225-6.355 6.343-10.581c2.12-4.238 1.06-7.937-.522-11.117-1.584-3.177-14.271-34.409-19.568-47.108-5.151-12.37-10.385-10.69-14.269-10.897-3.703-.183-7.927-.219-12.164-.219s-11.105 1.582-16.925 7.939c-5.82 6.354-22.209 21.709-22.209 52.927 0 31.22 22.733 61.405 25.911 65.642 3.177 4.237 44.745 68.318 108.389 95.812 15.135 6.538 26.957 10.446 36.175 13.368 15.196 4.834 29.027 4.153 39.96 2.52 12.19-1.825 37.54-15.353 42.824-30.172 5.283-14.818 5.283-27.529 3.701-30.172-1.582-2.641-5.819-4.237-12.163-7.414l.011-.024z"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            updateHeaderCounts();
        }

        function updateHeaderCounts() {
            document.getElementById('active-count').innerText = allAds.filter(a => a.estado === 'Activo').length;
            document.getElementById('scheduled-count').innerText = allAds.filter(a => a.estado === 'Programado').length;
        }

        function setFilter(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-active'));
            const btnId = status === 'all' ? 'btn-all' : (status === 'Activo' ? 'btn-activo' : 'btn-programado');
            document.getElementById(btnId).classList.add('filter-active');
            renderPublicView();
        }

        function copyToClipboard(text, element) {
            const temp = document.createElement("input");
            temp.value = text; document.body.appendChild(temp);
            temp.select(); document.execCommand("copy");
            document.body.removeChild(temp);
            const original = element.innerHTML;
            element.innerHTML = '<span class="text-blue-400 font-bold copy-feedback italic text-[10px]">¡Copiado!</span>';
            setTimeout(() => { element.innerHTML = original; }, 1500);
        }

        function openModal(ad) {
            const isActivo = ad.estado === 'Activo';
            
            document.getElementById('modalTitle').innerText = ad.nombre;
            document.getElementById('modalAsesora').innerText = ad.asesora_nombre;
            document.getElementById('modalCiudad').innerText = ad.ciudad;
            document.getElementById('modalFecha').innerText = ad.fecha_inicio;
            document.getElementById('modalDateLabel').innerText = isActivo ? 'Activo desde:' : 'Programado para:';
            
            // Lógica para el estado del Video REEL
            const videoStatus = ad.video_reel.toLowerCase();
            const statusLabel = document.getElementById('modalVideoStatus');
            const container = document.getElementById('modalVideoStatusContainer');
            
            statusLabel.innerText = ad.video_reel.toUpperCase();
            
            // Limpiar clases previas
            container.className = 'p-4 rounded-2xl transition-colors duration-300 ';
            statusLabel.className = 'font-black ';

            if (videoStatus === 'realizado') {
                container.classList.add('bg-green-50');
                statusLabel.classList.add('text-green-600');
            } else if (videoStatus === 'pendiente') {
                container.classList.add('bg-red-50');
                statusLabel.classList.add('text-red-600');
            } else if (videoStatus === 'en proceso') {
                container.classList.add('bg-orange-50');
                statusLabel.classList.add('text-orange-500');
            } else {
                container.classList.add('bg-slate-50');
                statusLabel.classList.add('text-slate-800');
            }
            
            // Estilo dinámico para el tipo en el modal
            const typeBadge = document.getElementById('modalTypeBadge');
            typeBadge.innerText = ad.tipo;
            const esPromo = ad.tipo === 'COMBO' || ad.tipo === 'TRICOMBO';
            typeBadge.className = `inline-block px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest mb-6 ${esPromo ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600'}`;

            document.getElementById('videoModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('videoModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        document.getElementById('searchInput').oninput = renderPublicView;
        fetchData();
    </script>
</body>
</html>
